<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Anara – Research Journal</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
<style>
  :root {
    --sidebar-bg: #111212;
    --sidebar-text: #c8c8c2;
    --sidebar-muted: #5a5a54;
    --sidebar-hover: #1e1f1e;
    --sidebar-active: #252624;
    --sidebar-accent: #c9f179;
    --content-bg: #f7f6f2;
    --content-card: #ffffff;
    --content-border: #e8e6df;
    --content-muted: #9a9891;
    --content-text: #1a1a18;
    --accent: #4a7c59;
    --accent-light: #e8f5ec;
    --accent-blue: #3d6b9e;
    --accent-blue-light: #eef3fa;
    --danger: #c0392b;
    --badge-bg: #2a2b2a;
    --right-bg: #fefefe;
    --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.04);
    --shadow-lg: 0 8px 30px rgba(0,0,0,0.10);
    --radius: 8px;
    --radius-sm: 5px;
    --transition: 0.18s ease;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--content-bg);
    color: var(--content-text);
    height: 100vh;
    overflow: hidden;
    display: flex;
  }

  /* ─── LAYOUT ─────────────────────────────────────────────── */
  #app { display: flex; width: 100%; height: 100vh; overflow: hidden; }

  /* ─── LEFT PANEL ──────────────────────────────────────────── */
  #left-panel {
    width: 230px;
    min-width: 230px;
    background: var(--sidebar-bg);
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
    transition: width var(--transition), min-width var(--transition);
    position: relative;
    z-index: 10;
    border-right: 1px solid #1e1f1e;
  }
  #left-panel.collapsed { width: 0; min-width: 0; overflow: hidden; }

  .sidebar-top {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 8px 0;
    scrollbar-width: thin;
    scrollbar-color: #2e2e2a transparent;
  }

  /* user row */
  .user-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px 8px 14px;
    cursor: pointer;
    border-radius: var(--radius-sm);
    margin: 4px 6px;
    transition: background var(--transition);
    position: relative;
  }
  .user-row:hover { background: var(--sidebar-hover); }
  .user-left { display: flex; align-items: center; gap: 8px; }
  .user-avatar {
    width: 26px; height: 26px; border-radius: 6px;
    background: linear-gradient(135deg, #c9f179, #4a7c59);
    font-size: 11px; font-weight: 600; color: #111;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .user-name {
    font-size: 13px; font-weight: 500; color: #e8e8e4;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    max-width: 120px;
  }
  .user-arrow {
    color: var(--sidebar-muted); font-size: 11px;
    transition: transform var(--transition);
  }
  .user-arrow.open { transform: rotate(180deg); }

  /* user dropdown */
  .user-dropdown {
    position: absolute;
    top: 100%; left: 6px; right: 6px;
    background: #1c1d1c;
    border: 1px solid #2a2b2a;
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    z-index: 100;
    overflow: hidden;
    display: none;
    min-width: 200px;
  }
  .user-dropdown.open { display: block; animation: fadeInDown 0.15s ease; }
  .dropdown-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 9px 14px; font-size: 13px; color: var(--sidebar-text);
    cursor: pointer; transition: background var(--transition);
    position: relative;
  }
  .dropdown-item:hover { background: var(--sidebar-hover); color: #fff; }
  .dropdown-item .di-left { display: flex; align-items: center; gap: 8px; }
  .dropdown-item .di-arrow { color: var(--sidebar-muted); font-size: 11px; }
  .dropdown-sep { height: 1px; background: #2a2b2a; margin: 3px 0; }

  /* workspace sub-menu */
  .workspace-submenu {
    position: absolute;
    left: 100%; top: 0;
    background: #1c1d1c;
    border: 1px solid #2a2b2a;
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    min-width: 180px;
    display: none;
    z-index: 101;
  }
  .workspace-submenu.open { display: block; animation: fadeIn 0.12s ease; }
  .ws-item {
    padding: 9px 14px; font-size: 13px; color: var(--sidebar-text);
    cursor: pointer; display: flex; align-items: center; gap: 8px;
    transition: background var(--transition);
  }
  .ws-item:hover { background: var(--sidebar-hover); color: #fff; }
  .ws-item.active { color: var(--sidebar-accent); }
  .ws-item.active::before { content: '✓'; font-size: 11px; margin-right: 2px; }
  .ws-item.new-ws {
    border-top: 1px solid #2a2b2a;
    color: var(--sidebar-accent);
    font-size: 12px;
  }

  /* nav items */
  .nav-section { padding: 8px 0; }
  .nav-item {
    display: flex; align-items: center; gap: 8px;
    padding: 7px 14px; font-size: 13px; color: var(--sidebar-text);
    cursor: pointer; border-radius: var(--radius-sm);
    margin: 1px 6px; transition: background var(--transition), color var(--transition);
    white-space: nowrap;
  }
  .nav-item:hover { background: var(--sidebar-hover); color: #e8e8e4; }
  .nav-item.active { background: var(--sidebar-active); color: #fff; }
  .nav-item svg { flex-shrink: 0; }

  /* folders */
  .folder-section { padding: 8px 0; }
  .section-label {
    font-size: 10px; font-weight: 600; letter-spacing: 0.08em;
    color: var(--sidebar-muted); padding: 4px 14px 6px;
    text-transform: uppercase;
  }
  .folder-item {
    display: flex; align-items: center; gap: 6px;
    padding: 5px 14px; font-size: 12.5px; color: var(--sidebar-muted);
    cursor: pointer; border-radius: var(--radius-sm);
    margin: 1px 6px; transition: background var(--transition), color var(--transition);
    position: relative;
  }
  .folder-item:hover { background: var(--sidebar-hover); color: var(--sidebar-text); }
  .folder-item.active { color: var(--sidebar-text); background: var(--sidebar-active); }
  .folder-toggle {
    width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;
    border-radius: 3px; transition: transform var(--transition);
    flex-shrink: 0;
  }
  .folder-toggle.open { transform: rotate(90deg); }
  .subfolder-list { display: none; }
  .subfolder-list.open { display: block; }
  .subfolder-item {
    display: flex; align-items: center; gap: 6px;
    padding: 4px 14px 4px 30px; font-size: 12px; color: var(--sidebar-muted);
    cursor: pointer; border-radius: var(--radius-sm);
    margin: 1px 6px; transition: background var(--transition), color var(--transition);
  }
  .subfolder-item:hover { background: var(--sidebar-hover); color: var(--sidebar-text); }
  .subfolder-item.muted { font-style: italic; font-size: 11px; opacity: 0.5; cursor: default; }
  .subfolder-item.muted:hover { background: none; }

  /* sidebar bottom */
  .sidebar-bottom {
    padding: 10px 8px;
    border-top: 1px solid #1e1f1e;
  }
  .plan-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 6px 8px; font-size: 12px; color: var(--sidebar-muted);
    cursor: pointer;
  }
  .plan-row:hover { color: var(--sidebar-text); }
  .plan-badge {
    font-size: 11px; font-weight: 600; color: var(--sidebar-accent);
    background: rgba(201,241,121,0.12); padding: 2px 6px;
    border-radius: 10px;
  }
  .progress-bar {
    height: 3px; border-radius: 2px; margin: 3px 8px 2px;
    background: #2a2b2a; overflow: hidden;
  }
  .progress-fill { height: 100%; border-radius: 2px; }
  .progress-fill.red { background: #c0392b; }
  .progress-fill.green { background: var(--accent); }
  .progress-label {
    display: flex; justify-content: space-between;
    font-size: 10.5px; color: var(--sidebar-muted);
    padding: 0 8px 6px;
  }
  .upgrade-btn {
    width: 100%; padding: 8px; background: #fff; color: #111;
    border: none; border-radius: var(--radius-sm); font-size: 13px;
    font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif;
    transition: background var(--transition), transform 0.1s;
    margin-top: 4px;
  }
  .upgrade-btn:hover { background: #f0f0ec; transform: translateY(-1px); }
  .sidebar-links {
    display: flex; gap: 4px; padding: 6px 8px 0;
  }
  .sidebar-link {
    display: flex; align-items: center; gap: 4px;
    font-size: 11.5px; color: var(--sidebar-muted);
    cursor: pointer; padding: 4px 6px; border-radius: var(--radius-sm);
    transition: background var(--transition), color var(--transition);
  }
  .sidebar-link:hover { background: var(--sidebar-hover); color: var(--sidebar-text); }

  /* ─── PANEL TOGGLE ──────────────────────────────────────── */
  .panel-toggle {
    position: absolute; top: 50%; transform: translateY(-50%);
    width: 18px; height: 36px; background: var(--sidebar-bg);
    border: 1px solid #2a2b2a; border-left: none;
    border-radius: 0 6px 6px 0;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; z-index: 20; color: var(--sidebar-muted);
    transition: background var(--transition), color var(--transition);
    right: -18px;
  }
  .panel-toggle:hover { background: var(--sidebar-hover); color: #fff; }

  /* ─── CENTER PANEL ────────────────────────────────────────── */
  #center-panel {
    flex: 1; display: flex; flex-direction: column;
    height: 100vh; overflow: hidden; background: var(--content-bg);
  }
  .center-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 20px; border-bottom: 1px solid var(--content-border);
    background: var(--content-bg); height: 46px; flex-shrink: 0;
  }
  .center-title {
    display: flex; align-items: center; gap: 8px;
    font-size: 14px; font-weight: 500; color: var(--content-text);
  }
  .center-title svg { color: var(--content-muted); }
  .header-actions { display: flex; align-items: center; gap: 6px; }
  .hdr-btn {
    padding: 5px 10px; border-radius: var(--radius-sm);
    font-size: 12px; font-weight: 500; cursor: pointer;
    border: 1px solid var(--content-border); background: var(--content-card);
    color: var(--content-text); display: flex; align-items: center; gap: 5px;
    transition: background var(--transition), border-color var(--transition);
    font-family: 'DM Sans', sans-serif;
  }
  .hdr-btn:hover { background: #f0eeea; border-color: #d0cec6; }
  .hdr-btn.upgrade {
    background: var(--sidebar-accent); border-color: var(--sidebar-accent);
    color: #111; font-weight: 600;
  }
  .hdr-btn.upgrade:hover { background: #b8e05e; }

  .center-body {
    flex: 1; overflow-y: auto; overflow-x: hidden;
    scrollbar-width: thin; scrollbar-color: #d0cdc5 transparent;
  }

  /* ─── HOME VIEW ───────────────────────────────────────────── */
  #view-home { padding: 36px 40px; max-width: 780px; }
  .view-section-label {
    font-size: 11px; font-weight: 600; letter-spacing: 0.07em;
    text-transform: uppercase; color: var(--content-muted);
    margin-bottom: 12px;
  }
  .quick-actions {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    margin-bottom: 32px;
  }
  .qa-card {
    background: var(--content-card); border: 1px solid var(--content-border);
    border-radius: var(--radius); padding: 14px 12px;
    cursor: pointer; transition: all var(--transition);
    display: flex; flex-direction: column; gap: 8px;
  }
  .qa-card:hover {
    border-color: #c0bdb4; box-shadow: var(--shadow);
    transform: translateY(-1px);
  }
  .qa-icon { color: var(--content-muted); }
  .qa-label { font-size: 13px; font-weight: 500; }

  .get-started-card {
    background: var(--content-card); border: 1px solid var(--content-border);
    border-radius: var(--radius); overflow: hidden;
  }
  .gs-item {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 16px; border-bottom: 1px solid var(--content-border);
    cursor: pointer; transition: background var(--transition);
    font-size: 13.5px;
  }
  .gs-item:last-child { border-bottom: none; }
  .gs-item:hover { background: #faf9f6; }
  .gs-item.done { color: var(--content-muted); text-decoration: line-through; }
  .gs-check {
    width: 18px; height: 18px; border-radius: 50%;
    border: 2px solid var(--content-border); flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    transition: all var(--transition);
  }
  .gs-item.done .gs-check { background: var(--accent); border-color: var(--accent); }

  /* ─── LIBRARY VIEW ────────────────────────────────────────── */
  #view-library { display: flex; flex-direction: column; height: 100%; }
  .library-toolbar {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 20px; border-bottom: 1px solid var(--content-border);
    flex-shrink: 0; flex-wrap: wrap;
  }
  .toolbar-btn {
    display: flex; align-items: center; gap: 5px;
    padding: 5px 10px; border-radius: var(--radius-sm);
    font-size: 12.5px; font-weight: 500; cursor: pointer;
    border: 1px solid var(--content-border); background: var(--content-card);
    color: var(--content-text); transition: all var(--transition);
    font-family: 'DM Sans', sans-serif; position: relative;
  }
  .toolbar-btn:hover { background: #f0eeea; border-color: #c8c5bc; }
  .toolbar-btn.active { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }
  .lib-count {
    margin-left: auto; font-size: 12px; color: var(--content-muted);
  }

  /* table */
  .lib-table-wrap { flex: 1; overflow-y: auto; overflow-x: auto; }
  .lib-table {
    width: 100%; border-collapse: collapse;
    font-size: 13px;
  }
  .lib-table thead tr {
    border-bottom: 2px solid var(--content-border);
    background: var(--content-bg);
    position: sticky; top: 0; z-index: 1;
  }
  .lib-table th {
    padding: 10px 16px; text-align: left;
    font-size: 11.5px; font-weight: 600; color: var(--content-muted);
    letter-spacing: 0.04em; cursor: pointer; white-space: nowrap;
    user-select: none;
  }
  .lib-table th:hover { color: var(--content-text); }
  .lib-table td {
    padding: 10px 16px; border-bottom: 1px solid var(--content-border);
    vertical-align: middle; max-width: 240px; overflow: hidden;
    text-overflow: ellipsis; white-space: nowrap;
  }
  .lib-table tr:hover td { background: #faf9f6; }
  .file-icon { color: var(--content-muted); margin-right: 6px; }
  .available-badge {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 11.5px; color: var(--accent); background: var(--accent-light);
    padding: 2px 8px; border-radius: 10px; font-weight: 500;
  }
  .summary-text { color: var(--content-muted); font-size: 12px; max-width: 300px; }

  /* tab view */
  #lib-tab-view { display: none; flex: 1; overflow: hidden; flex-direction: column; }
  #lib-tab-view.active { display: flex; }
  #lib-table-view { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
  #lib-table-view.hidden { display: none; }
  .doc-tabs-bar {
    display: flex; align-items: center; gap: 0;
    border-bottom: 1px solid var(--content-border);
    background: var(--content-bg); overflow-x: auto;
    flex-shrink: 0;
    scrollbar-width: none;
  }
  .doc-tab {
    display: flex; align-items: center; gap: 6px;
    padding: 8px 16px; font-size: 12.5px; cursor: pointer;
    border-right: 1px solid var(--content-border);
    white-space: nowrap; min-width: 0;
    transition: background var(--transition); color: var(--content-muted);
  }
  .doc-tab:hover { background: #f0eeea; color: var(--content-text); }
  .doc-tab.active {
    background: var(--content-card); color: var(--content-text);
    font-weight: 500;
  }
  .doc-tab .close-tab {
    width: 14px; height: 14px; border-radius: 3px;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; color: var(--content-muted);
    transition: background var(--transition), color var(--transition);
    flex-shrink: 0;
  }
  .doc-tab .close-tab:hover { background: #e0ddd5; color: var(--content-text); }
  .doc-content {
    flex: 1; overflow-y: auto; padding: 40px;
    background: var(--content-card);
    font-family: 'Lora', serif; line-height: 1.8; font-size: 15px;
    color: #2a2a26;
  }
  .doc-content h1 { font-size: 22px; margin-bottom: 16px; font-weight: 600; line-height: 1.3; }
  .doc-content h2 { font-size: 17px; margin: 24px 0 10px; font-weight: 600; }
  .doc-content p { margin-bottom: 14px; }
  .doc-content .meta { color: var(--content-muted); font-size: 13px; font-family: 'DM Sans', sans-serif; margin-bottom: 24px; }

  /* ─── DROPDOWN OVERLAYS ───────────────────────────────────── */
  .fl-dropdown {
    position: absolute; top: 100%; left: 0; margin-top: 4px;
    background: var(--content-card); border: 1px solid var(--content-border);
    border-radius: var(--radius); box-shadow: var(--shadow-lg);
    z-index: 200; min-width: 180px; display: none; overflow: hidden;
  }
  .fl-dropdown.open { display: block; animation: fadeInDown 0.13s ease; }
  .fl-item {
    padding: 8px 14px; font-size: 13px; cursor: pointer;
    transition: background var(--transition); display: flex; align-items: center; gap: 8px;
  }
  .fl-item:hover { background: #f5f4f0; }
  .fl-item.checked { color: var(--accent); font-weight: 500; }
  .fl-sep { height: 1px; background: var(--content-border); margin: 3px 0; }
  .col-check { width: 14px; }

  /* ─── AGENT VIEW ──────────────────────────────────────────── */
  #view-agent { display: flex; flex-direction: column; height: 100%; }
  .agent-messages {
    flex: 1; overflow-y: auto; padding: 32px 40px;
    scrollbar-width: thin; scrollbar-color: #d0cdc5 transparent;
  }
  .empty-agent {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 100%; gap: 16px; color: var(--content-muted);
  }
  .empty-agent-title {
    font-family: 'Lora', serif; font-size: 22px; color: var(--content-text);
    font-style: italic;
  }
  .agent-chips {
    display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
    max-width: 520px;
  }
  .agent-chip {
    display: flex; align-items: center; gap: 5px;
    padding: 6px 12px; border-radius: 20px;
    border: 1px solid var(--content-border); background: var(--content-card);
    font-size: 12.5px; cursor: pointer; transition: all var(--transition);
    color: var(--content-text);
  }
  .agent-chip:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }

  /* agent input area */
  .agent-input-area {
    padding: 12px 20px 16px;
    border-top: 1px solid var(--content-border);
    background: var(--content-bg); flex-shrink: 0;
  }
  .chat-box {
    background: var(--content-card); border: 1px solid var(--content-border);
    border-radius: 12px; padding: 10px 12px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.04);
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .chat-box:focus-within {
    border-color: #b0ada4; box-shadow: 0 2px 12px rgba(0,0,0,0.07);
  }
  .chat-textarea {
    width: 100%; border: none; outline: none; resize: none;
    font-family: 'DM Sans', sans-serif; font-size: 14px;
    color: var(--content-text); background: transparent;
    min-height: 42px; max-height: 160px; line-height: 1.5;
  }
  .chat-textarea::placeholder { color: var(--content-muted); }
  .chat-toolbar {
    display: flex; align-items: center; gap: 6px;
    padding-top: 8px; flex-wrap: wrap;
  }
  .ct-btn {
    display: flex; align-items: center; gap: 4px;
    padding: 4px 9px; border-radius: 20px;
    font-size: 12px; font-weight: 500; cursor: pointer;
    border: 1px solid var(--content-border); background: var(--content-bg);
    color: var(--content-text); transition: all var(--transition);
    font-family: 'DM Sans', sans-serif; position: relative;
  }
  .ct-btn:hover { background: #f0eeea; border-color: #c8c5bc; }
  .ct-btn.active { background: var(--accent-blue-light); border-color: var(--accent-blue); color: var(--accent-blue); }
  .ct-btn.mention { color: var(--accent-blue); border-color: #b0c4dc; background: var(--accent-blue-light); }
  .ct-btn.selected { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }
  .ct-right { margin-left: auto; display: flex; align-items: center; gap: 5px; }
  .submit-btn {
    width: 30px; height: 30px; border-radius: 8px;
    background: var(--sidebar-bg); color: #fff;
    border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: background var(--transition), transform 0.1s;
    flex-shrink: 0;
  }
  .submit-btn:hover { background: #333; transform: scale(1.05); }
  .attach-btn {
    width: 28px; height: 28px; border-radius: 7px;
    border: 1px solid var(--content-border); background: var(--content-bg);
    color: var(--content-muted); display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all var(--transition);
    flex-shrink: 0;
  }
  .attach-btn:hover { background: #f0eeea; color: var(--content-text); }

  /* @mention popup */
  .mention-popup {
    position: absolute; bottom: 100%; left: 0; right: 0; margin-bottom: 6px;
    background: var(--content-card); border: 1px solid var(--content-border);
    border-radius: 10px; box-shadow: var(--shadow-lg);
    max-height: 260px; overflow-y: auto; display: none; z-index: 200;
  }
  .mention-popup.open { display: block; animation: fadeInDown 0.13s ease; }
  .mention-section { padding: 6px 0; }
  .mention-label {
    font-size: 10px; font-weight: 700; letter-spacing: 0.08em;
    text-transform: uppercase; color: var(--content-muted);
    padding: 4px 14px 2px;
  }
  .mention-item {
    display: flex; align-items: center; gap: 10px;
    padding: 7px 14px; font-size: 13px; cursor: pointer;
    transition: background var(--transition);
  }
  .mention-item:hover { background: #f5f4f0; }
  .mention-item .mi-icon {
    width: 26px; height: 26px; border-radius: 6px;
    background: var(--accent-light); color: var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; flex-shrink: 0;
  }
  .mention-item .mi-icon.tool { background: #f3f0fc; color: #7c5cbf; }
  .mention-item .mi-icon.folder { background: #fef5e7; color: #c67c1a; }
  .mention-item .mi-label { font-weight: 500; font-size: 13px; }
  .mention-item .mi-desc { font-size: 11.5px; color: var(--content-muted); }

  /* settings popup (knob) */
  .knob-popup {
    position: absolute; bottom: 100%; right: 0; margin-bottom: 6px;
    background: var(--content-card); border: 1px solid var(--content-border);
    border-radius: 10px; box-shadow: var(--shadow-lg);
    width: 240px; display: none; z-index: 200; padding: 10px 0;
  }
  .knob-popup.open { display: block; animation: fadeInDown 0.13s ease; }
  .knob-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 14px; font-size: 13px;
  }
  .knob-item label { color: var(--content-muted); font-size: 12px; }
  .knob-select {
    border: 1px solid var(--content-border); border-radius: 5px;
    padding: 3px 6px; font-size: 12px; color: var(--content-text);
    background: var(--content-bg); cursor: pointer;
    font-family: 'DM Sans', sans-serif;
  }

  /* chat messages */
  .msg { margin-bottom: 20px; animation: fadeIn 0.2s ease; }
  .msg.user { display: flex; justify-content: flex-end; }
  .msg.assistant { display: flex; gap: 10px; }
  .msg-bubble {
    max-width: 72%; padding: 10px 14px; border-radius: 12px;
    font-size: 14px; line-height: 1.6;
  }
  .msg.user .msg-bubble { background: var(--sidebar-bg); color: #e8e8e4; border-radius: 12px 12px 2px 12px; }
  .msg.assistant .msg-bubble { background: var(--content-card); border: 1px solid var(--content-border); color: var(--content-text); border-radius: 2px 12px 12px 12px; }
  .msg-avatar {
    width: 28px; height: 28px; border-radius: 7px;
    background: linear-gradient(135deg, var(--sidebar-accent), var(--accent));
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: #111; flex-shrink: 0;
  }
  .citation-link {
    display: inline-flex; align-items: center; justify-content: center;
    width: 18px; height: 18px; border-radius: 4px;
    background: var(--accent-light); color: var(--accent);
    font-size: 10px; font-weight: 700; cursor: pointer;
    transition: background var(--transition); margin: 0 1px;
    text-decoration: none; vertical-align: super;
  }
  .citation-link:hover { background: var(--accent); color: #fff; }

  /* ─── RIGHT PANEL ────────────────────────────────────────── */
  #right-panel {
    width: 300px; min-width: 300px;
    background: var(--right-bg);
    border-left: 1px solid var(--content-border);
    display: flex; flex-direction: column;
    height: 100vh; overflow: hidden;
    transition: width var(--transition), min-width var(--transition);
  }
  #right-panel.collapsed { width: 0; min-width: 0; overflow: hidden; }
  .right-header {
    padding: 10px 16px; border-bottom: 1px solid var(--content-border);
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0; height: 46px;
  }
  .right-title { font-size: 13px; font-weight: 600; }
  .right-body { flex: 1; overflow-y: auto; padding: 16px; }
  .right-empty {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; height: 100%; color: var(--content-muted);
    font-size: 13px; text-align: center; gap: 8px;
  }

  .ctx-section { margin-bottom: 20px; }
  .ctx-label {
    font-size: 10.5px; font-weight: 700; letter-spacing: 0.07em;
    text-transform: uppercase; color: var(--content-muted);
    margin-bottom: 8px;
  }
  .ctx-item {
    display: flex; align-items: flex-start; gap: 8px;
    padding: 8px 10px; background: #f5f4f0; border-radius: var(--radius-sm);
    font-size: 12.5px; margin-bottom: 4px; cursor: pointer;
    border: 1px solid transparent; transition: all var(--transition);
  }
  .ctx-item:hover { border-color: var(--accent); background: var(--accent-light); }
  .ctx-num {
    width: 20px; height: 20px; border-radius: 4px;
    background: var(--accent-light); color: var(--accent);
    font-size: 10px; font-weight: 700; display: flex;
    align-items: center; justify-content: center; flex-shrink: 0;
  }
  .ctx-text { line-height: 1.5; color: var(--content-text); }
  .ctx-source { font-size: 11px; color: var(--content-muted); margin-top: 2px; }

  /* ─── MODALS ──────────────────────────────────────────────── */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.45);
    z-index: 1000; display: none; align-items: center; justify-content: center;
    animation: fadeIn 0.15s ease;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--content-card); border-radius: 12px;
    box-shadow: var(--shadow-lg); padding: 28px; min-width: 380px;
    max-width: 90vw; animation: slideUp 0.2s ease;
  }
  .modal h3 { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
  .modal p { font-size: 13px; color: var(--content-muted); margin-bottom: 20px; }
  .modal input, .modal select {
    width: 100%; padding: 9px 12px; border: 1px solid var(--content-border);
    border-radius: var(--radius-sm); font-size: 14px;
    font-family: 'DM Sans', sans-serif; color: var(--content-text);
    background: var(--content-bg); outline: none;
    transition: border-color 0.2s;
  }
  .modal input:focus, .modal select:focus { border-color: var(--accent); }
  .modal-actions { display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end; }
  .btn-primary {
    padding: 8px 18px; background: var(--sidebar-bg); color: #fff;
    border: none; border-radius: var(--radius-sm); font-size: 13px;
    font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif;
    transition: background var(--transition);
  }
  .btn-primary:hover { background: #2a2b2a; }
  .btn-secondary {
    padding: 8px 18px; background: transparent; color: var(--content-text);
    border: 1px solid var(--content-border); border-radius: var(--radius-sm);
    font-size: 13px; cursor: pointer; font-family: 'DM Sans', sans-serif;
    transition: background var(--transition);
  }
  .btn-secondary:hover { background: #f0eeea; }

  /* file select modal */
  .file-option {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px; border: 1px solid var(--content-border);
    border-radius: var(--radius-sm); cursor: pointer;
    transition: all var(--transition); margin-bottom: 8px;
  }
  .file-option:hover { border-color: var(--accent); background: var(--accent-light); }
  .file-option.selected { border-color: var(--accent); background: var(--accent-light); }
  .file-option-check {
    width: 18px; height: 18px; border-radius: 4px;
    border: 2px solid var(--content-border);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all var(--transition);
  }
  .file-option.selected .file-option-check { background: var(--accent); border-color: var(--accent); }

  /* ─── ANIMATIONS ──────────────────────────────────────────── */
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes fadeInDown { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

  /* right panel toggle */
  .right-toggle {
    position: absolute; right: 0; top: 50%; transform: translateY(-50%);
    display: none; /* shown when panel collapses */
  }
  #right-panel.collapsed + .right-toggle { display: flex; }

  /* tooltip */
  [data-tip] { position: relative; }
  [data-tip]:hover::after {
    content: attr(data-tip);
    position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
    background: #111; color: #fff; font-size: 11px; padding: 4px 8px;
    border-radius: 4px; white-space: nowrap; margin-bottom: 4px;
    pointer-events: none; z-index: 999;
  }

  /* thinking indicator */
  .typing-dot {
    display: inline-block; width: 7px; height: 7px; border-radius: 50%;
    background: var(--content-muted); margin: 0 2px;
    animation: blink 1.2s ease-in-out infinite;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes blink { 0%,100%{opacity:0.3} 50%{opacity:1} }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #d0cdc5; border-radius: 3px; }

  /* New workspace form */
  .ws-new-form { display: none; padding: 8px 10px; border-top: 1px solid #2a2b2a; }
  .ws-new-form.open { display: block; }
  .ws-new-input {
    width: 100%; padding: 6px 10px; border: 1px solid #3a3b3a;
    border-radius: 5px; background: #111; color: #e8e8e4;
    font-size: 12.5px; outline: none; font-family: 'DM Sans', sans-serif;
  }
  .ws-new-input:focus { border-color: var(--sidebar-accent); }
</style>
</head>
<body>
<div id="app">

  <!-- ───────── LEFT PANEL ───────── -->
  <div id="left-panel">
    <div class="sidebar-top">

      <!-- User row -->
      <div class="user-row" id="user-row" onclick="toggleUserDropdown(event)">
        <div class="user-left">
          <div class="user-avatar">SV</div>
          <span class="user-name">Shivansh Verm...</span>
        </div>
        <span class="user-arrow" id="user-arrow">▾</span>
      </div>

      <!-- User dropdown -->
      <div class="user-dropdown" id="user-dropdown">
        <div class="dropdown-item" onclick="openModal('settings')">
          <div class="di-left">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            Settings
          </div>
        </div>
        <div class="dropdown-item" id="ws-toggle" onmouseenter="openWsSubmenu()" onmouseleave="scheduleCloseWs()">
          <div class="di-left">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
            Switch workspace
          </div>
          <span class="di-arrow">›</span>
          <div class="workspace-submenu" id="ws-submenu" onmouseenter="cancelCloseWs()" onmouseleave="scheduleCloseWs()">
            <div class="ws-item active" onclick="switchWorkspace('Main Research')">Main Research</div>
            <div class="ws-item" id="ws-personal" onclick="switchWorkspace('Personal Projects')">Personal Projects</div>
            <div class="ws-item" id="ws-collab" onclick="switchWorkspace('Collaboration')">Collaboration</div>
            <div class="ws-item new-ws" onclick="showNewWsForm()">+ New workspace</div>
            <div class="ws-new-form" id="ws-new-form">
              <input class="ws-new-input" id="ws-new-input" placeholder="Workspace name…" onkeydown="handleNewWs(event)" />
            </div>
          </div>
        </div>
        <div class="dropdown-sep"></div>
        <div class="dropdown-item" onclick="closeDropdowns()">
          <div class="di-left">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Sign out
          </div>
        </div>
      </div>

      <!-- Nav -->
      <div class="nav-section">
        <div class="nav-item active" id="nav-home" onclick="switchTab('home')">
          <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Home
        </div>
        <div class="nav-item" id="nav-library" onclick="switchTab('library')">
          <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
          Library
        </div>
        <div class="nav-item" id="nav-agent" onclick="switchTab('agent')">
          <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
          Agent
        </div>
      </div>

      <!-- Folders -->
      <div class="folder-section">
        <div class="section-label">Private</div>

        <div class="folder-item" onclick="toggleFolder('folder-another', this)">
          <span class="folder-toggle" id="toggle-folder-another">›</span>
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
          Another Folder
        </div>
        <div class="subfolder-list" id="folder-another">
          <div class="subfolder-item" onclick="toggleFolder('folder-new-sub', this)">
            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
            new subfolder
          </div>
          <div class="subfolder-list" id="folder-new-sub">
            <div class="subfolder-item muted" style="padding-left: 46px;">No subfolders</div>
          </div>
        </div>

        <div class="folder-item active" onclick="toggleFolder('folder-trans', this)">
          <span class="folder-toggle" id="toggle-folder-trans">›</span>
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
          Transcendental Numbers
        </div>
        <div class="subfolder-list" id="folder-trans">
          <div class="subfolder-item">
            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            Transcendental Numbers.pdf
          </div>
          <div class="subfolder-item" onclick="openModal('new-subfolder')">
            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            New subfolder
          </div>
        </div>
      </div>

    </div>

    <!-- Sidebar bottom -->
    <div class="sidebar-bottom">
      <div class="plan-row" onclick="togglePlanDetails()">
        <span style="font-size:11.5px">Plan usage</span>
        <span class="plan-badge">Free</span>
        <span style="color:var(--sidebar-muted); font-size:11px; margin-left:4px">▾</span>
      </div>
      <div id="plan-details">
        <div style="padding:2px 8px; font-size:11px; color:var(--sidebar-muted); display:flex; justify-content:space-between">
          <span>AI words/day <span style="opacity:0.5">ⓘ</span></span><span>1000/1000</span>
        </div>
        <div class="progress-bar"><div class="progress-fill red" style="width:100%"></div></div>
        <div style="padding:2px 8px 6px; font-size:11px; color:var(--sidebar-muted); display:flex; justify-content:space-between">
          <span>Imports/day <span style="opacity:0.5">ⓘ</span></span><span>1/5</span>
        </div>
        <div class="progress-bar"><div class="progress-fill green" style="width:20%"></div></div>
      </div>
      <button class="upgrade-btn" onclick="openModal('upgrade')">Upgrade</button>
      <div class="sidebar-links">
        <div class="sidebar-link">
          <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3H14z"/><path d="M7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>
          Feedback
        </div>
        <div class="sidebar-link">
          <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          Support
        </div>
      </div>
    </div>

    <div class="panel-toggle" id="left-toggle" onclick="toggleLeft()" data-tip="Collapse">
      <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    </div>
  </div>

  <!-- ───────── CENTER PANEL ───────── -->
  <div id="center-panel">

    <!-- Header -->
    <div class="center-header" id="center-header">
      <div class="center-title" id="center-title">
        <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
        Home
      </div>
      <div class="header-actions">
        <button class="hdr-btn" id="left-open-btn" style="display:none" onclick="toggleLeft()">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <button class="hdr-btn" id="right-toggle-btn" onclick="toggleRight()">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
        </button>
        <button class="hdr-btn upgrade" onclick="openModal('upgrade')">↑ Upgrade</button>
      </div>
    </div>

    <div class="center-body">

      <!-- ── HOME VIEW ── -->
      <div id="view-home">
        <div class="view-section-label">Quick actions</div>
        <div class="quick-actions">
          <div class="qa-card" onclick="openModal('upload')">
            <div class="qa-icon"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg></div>
            <div class="qa-label">Upload</div>
          </div>
          <div class="qa-card" onclick="openModal('create')">
            <div class="qa-icon"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
            <div class="qa-label">Create</div>
          </div>
          <div class="qa-card" onclick="openModal('chat-file')">
            <div class="qa-icon"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
            <div class="qa-label">Chat with file</div>
          </div>
          <div class="qa-card" onclick="openModal('chat-folder')">
            <div class="qa-icon"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></div>
            <div class="qa-label">Chat with folder</div>
          </div>
        </div>

        <div class="view-section-label">Get started</div>
        <div class="get-started-card">
          <div class="gs-item" onclick="openModal('chat-file')">
            <div class="gs-check"></div>
            Chat with a file
          </div>
          <div class="gs-item" onclick="openModal('chat-folder')">
            <div class="gs-check"></div>
            Add files to a folder and chat with them
          </div>
          <div class="gs-item" onclick="openModal('create')">
            <div class="gs-check"></div>
            Create a new note
          </div>
          <div class="gs-item done">
            <div class="gs-check">
              <svg width="10" height="10" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
            Search for papers with agent
          </div>
          <div class="gs-item" onclick="openModal('connect')">
            <div class="gs-check"></div>
            Connect Zotero or Mendeley and import a file
          </div>
          <div class="gs-item" onclick="switchTab('library')">
            <div class="gs-check"></div>
            Add a comment to a file
          </div>
          <div class="gs-item" onclick="switchTab('agent')">
            <div class="gs-check"></div>
            Search for a citation in a note
          </div>
        </div>
      </div>

      <!-- ── LIBRARY VIEW ── -->
      <div id="view-library" style="display:none">
        <div class="library-toolbar" id="lib-toolbar">
          <div style="position:relative">
            <button class="toolbar-btn" id="display-btn" onclick="toggleDropdown('display-dd')">
              <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
              Display ▾
            </button>
            <div class="fl-dropdown" id="display-dd">
              <div class="fl-item" onclick="setLibView('table', this)">
                <svg class="col-check" width="13" height="13" fill="none" stroke="#4a7c59" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                Table view
              </div>
              <div class="fl-item" onclick="setLibView('tab', this)">
                <span class="col-check"></span>
                Tab view
              </div>
              <div class="fl-sep"></div>
              <div style="padding:6px 14px; font-size:11px; font-weight:600; color:var(--content-muted); letter-spacing:0.06em; text-transform:uppercase">Columns</div>
              <div class="fl-item checked" onclick="toggleCol(this,'col-title')"><svg class="col-check" width="13" height="13" fill="none" stroke="#4a7c59" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Title</div>
              <div class="fl-item checked" onclick="toggleCol(this,'col-authors')"><svg class="col-check" width="13" height="13" fill="none" stroke="#4a7c59" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Authors</div>
              <div class="fl-item checked" onclick="toggleCol(this,'col-added')"><svg class="col-check" width="13" height="13" fill="none" stroke="#4a7c59" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Added</div>
              <div class="fl-item checked" onclick="toggleCol(this,'col-fulltext')"><svg class="col-check" width="13" height="13" fill="none" stroke="#4a7c59" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Full text</div>
              <div class="fl-item checked" onclick="toggleCol(this,'col-viewed')"><svg class="col-check" width="13" height="13" fill="none" stroke="#4a7c59" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Viewed</div>
              <div class="fl-item checked" onclick="toggleCol(this,'col-filetype')"><svg class="col-check" width="13" height="13" fill="none" stroke="#4a7c59" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>File type</div>
              <div class="fl-item checked" onclick="toggleCol(this,'col-summary')"><svg class="col-check" width="13" height="13" fill="none" stroke="#4a7c59" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Summary</div>
            </div>
          </div>

          <div style="position:relative">
            <button class="toolbar-btn" onclick="toggleDropdown('sort-dd')">
              <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
              Sort ▾
            </button>
            <div class="fl-dropdown" id="sort-dd">
              <div class="fl-item" onclick="sortLib('title')">Title A–Z</div>
              <div class="fl-item" onclick="sortLib('author')">Author</div>
              <div class="fl-item" onclick="sortLib('added')">Date added</div>
              <div class="fl-item" onclick="sortLib('viewed')">Last viewed</div>
              <div class="fl-item" onclick="sortLib('folder')">Folder</div>
            </div>
          </div>

          <div style="position:relative">
            <button class="toolbar-btn" onclick="toggleDropdown('filter-dd')">
              <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
              Filter ▾
            </button>
            <div class="fl-dropdown" id="filter-dd" style="min-width:220px">
              <div style="padding:8px 14px; font-size:12px; color:var(--content-muted)">Filter by</div>
              <div class="fl-item" onclick="filterLib('file-type')">File type</div>
              <div class="fl-item" onclick="filterLib('author')">Author</div>
              <div class="fl-item" onclick="filterLib('folder')">Folder</div>
              <div class="fl-item" onclick="filterLib('full-text')">Full text availability</div>
              <div class="fl-item" onclick="filterLib('date')">Date range</div>
            </div>
          </div>

          <span class="lib-count" id="lib-count">1 file in library</span>
        </div>

        <!-- Table view -->
        <div id="lib-table-view" class="lib-table-wrap">
          <table class="lib-table">
            <thead>
              <tr>
                <th style="width:32px"><input type="checkbox" /></th>
                <th class="col-title" onclick="sortLib('title')">Title ↕</th>
                <th class="col-authors" onclick="sortLib('author')">Authors</th>
                <th class="col-added" onclick="sortLib('added')">Added</th>
                <th class="col-fulltext">Full text</th>
                <th class="col-viewed" onclick="sortLib('viewed')">Viewed</th>
                <th class="col-filetype">File type</th>
                <th class="col-summary">Summary</th>
              </tr>
            </thead>
            <tbody id="lib-tbody">
              <tr onclick="openDocTab('Transcendental Numbers', 'Murty et al.')">
                <td><input type="checkbox" onclick="event.stopPropagation()"/></td>
                <td><svg class="file-icon" width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" style="display:inline"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Transcendental Numbers</td>
                <td>Murty, et al.</td>
                <td>Today</td>
                <td><span class="available-badge">✓ Available</span></td>
                <td>19 minutes ago</td>
                <td>Document</td>
                <td class="summary-text">**Summary (≈120 words)** Murty and Rath's *Transcen…</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Tab view -->
        <div id="lib-tab-view">
          <div class="doc-tabs-bar" id="doc-tabs-bar"></div>
          <div class="doc-content" id="doc-content-area">
            <div class="right-empty" style="height:200px; color:var(--content-muted); font-size:13px; display:flex; align-items:center; justify-content:center">
              Open a file from the library to read it here.
            </div>
          </div>
        </div>
      </div>

      <!-- ── AGENT VIEW ── -->
      <div id="view-agent" style="display:none">
        <div class="agent-messages" id="agent-messages">
          <div class="empty-agent" id="agent-empty">
            <div class="agent-empty-icon" style="opacity:0.3">
              <svg width="36" height="36" fill="none" stroke="currentColor" stroke-width="1.4" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
            </div>
            <div class="empty-agent-title">Understand, research and write about anything</div>
            <div style="font-size:13px; color:var(--content-muted)">Use @ to bring in agents, files, folders, and tools</div>
            <div class="agent-chips">
              <div class="agent-chip" onclick="setPrompt('Outline a literature review on ')">📝 Outline literature review</div>
              <div class="agent-chip" onclick="setPrompt('Search for recent papers on ')">🔍 Search for papers</div>
              <div class="agent-chip" onclick="setPrompt('Chat with my file about ')">💬 Chat with file</div>
              <div class="agent-chip" onclick="setPrompt('Search my workspace for ')">🗂 Search workspace</div>
              <div class="agent-chip" onclick="setPrompt('Create a citation for ')">📖 Create citation</div>
              <div class="agent-chip" onclick="setPrompt('Summarize and discuss ')">✨ More…</div>
            </div>
          </div>
        </div>
        <div class="agent-input-area">
          <div class="chat-box" style="position:relative">
            <div class="mention-popup" id="mention-popup">
              <div class="mention-section">
                <div class="mention-label">Agents</div>
                <div class="mention-item" onclick="selectMention('Paper Search', 'agent')">
                  <div class="mi-icon">🔍</div>
                  <div><div class="mi-label">Paper Search</div><div class="mi-desc">Search academic databases</div></div>
                </div>
                <div class="mention-item" onclick="selectMention('Workspace Search', 'agent')">
                  <div class="mi-icon">🗂</div>
                  <div><div class="mi-label">Workspace Search</div><div class="mi-desc">Search your library</div></div>
                </div>
                <div class="mention-item" onclick="selectMention('Citation Agent', 'agent')">
                  <div class="mi-icon">📖</div>
                  <div><div class="mi-label">Citation Agent</div><div class="mi-desc">Find and format citations</div></div>
                </div>
              </div>
              <div class="mention-section">
                <div class="mention-label">Folders</div>
                <div class="mention-item" onclick="selectMention('Transcendental Numbers', 'folder')">
                  <div class="mi-icon folder">📁</div>
                  <div><div class="mi-label">Transcendental Numbers</div><div class="mi-desc">1 file</div></div>
                </div>
                <div class="mention-item" onclick="selectMention('Another Folder', 'folder')">
                  <div class="mi-icon folder">📁</div>
                  <div><div class="mi-label">Another Folder</div><div class="mi-desc">0 files</div></div>
                </div>
              </div>
              <div class="mention-section">
                <div class="mention-label">Files</div>
                <div class="mention-item" onclick="selectMention('Transcendental Numbers.pdf', 'file')">
                  <div class="mi-icon">📄</div>
                  <div><div class="mi-label">Transcendental Numbers.pdf</div><div class="mi-desc">Murty et al. · Today</div></div>
                </div>
              </div>
              <div class="mention-section">
                <div class="mention-label">Tools</div>
                <div class="mention-item" onclick="selectMention('Web Search', 'tool')">
                  <div class="mi-icon tool">🌐</div>
                  <div><div class="mi-label">Web Search</div></div>
                </div>
                <div class="mention-item" onclick="selectMention('YouTube Search', 'tool')">
                  <div class="mi-icon tool">▶️</div>
                  <div><div class="mi-label">YouTube Search</div></div>
                </div>
                <div class="mention-item" onclick="selectMention('Create Image', 'tool')">
                  <div class="mi-icon tool">🎨</div>
                  <div><div class="mi-label">Create Image</div></div>
                </div>
                <div class="mention-item" onclick="selectMention('Zotero Search', 'tool')">
                  <div class="mi-icon tool">📚</div>
                  <div><div class="mi-label">Zotero Search</div></div>
                </div>
              </div>
            </div>

            <textarea class="chat-textarea" id="chat-input" placeholder="Understand, research and write about anything"
              onkeydown="handleChatKey(event)" oninput="handleChatInput(event)" rows="1"></textarea>

            <div class="chat-toolbar">
              <button class="ct-btn mention" onclick="toggleMention()">@ Mention</button>

              <div style="position:relative">
                <button class="ct-btn" id="model-btn" onclick="toggleDropdown('model-dd')">
                  <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
                  <span id="model-label">GPT OSS</span> ▾
                </button>
                <div class="fl-dropdown" id="model-dd">
                  <div class="fl-item" onclick="selectModel('GPT OSS')">GPT OSS</div>
                  <div class="fl-item" onclick="selectModel('Claude Sonnet')">Claude Sonnet</div>
                  <div class="fl-item" onclick="selectModel('Gemini Pro')">Gemini Pro</div>
                  <div class="fl-item" onclick="selectModel('Qwen 2.5')">Qwen 2.5</div>
                </div>
              </div>

              <div style="position:relative">
                <button class="ct-btn" id="words-btn" onclick="toggleDropdown('words-dd')">
                  <span id="words-label">250 words</span> ▾
                </button>
                <div class="fl-dropdown" id="words-dd">
                  <div class="fl-item" onclick="selectWords('100 words')">100 words</div>
                  <div class="fl-item" onclick="selectWords('250 words')">250 words</div>
                  <div class="fl-item" onclick="selectWords('500 words')">500 words</div>
                  <div class="fl-item" onclick="selectWords('1000 words')">1000 words</div>
                  <div class="fl-item" onclick="selectWords('No limit')">No limit</div>
                </div>
              </div>

              <!-- Knob / Settings -->
              <div style="position:relative">
                <button class="ct-btn" id="knob-btn" onclick="toggleDropdown('knob-dd')" title="Settings">
                  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06-.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                </button>
                <div class="knob-popup" id="knob-dd">
                  <div class="knob-item"><label>Scope</label>
                    <select class="knob-select" onchange="updateKnob('scope',this.value)">
                      <option>Workspace</option><option>Internet</option><option>Model knowledge</option>
                    </select>
                  </div>
                  <div class="knob-item"><label>Language</label>
                    <select class="knob-select" onchange="updateKnob('lang',this.value)">
                      <option>English</option><option>Hindi</option><option>Spanish</option><option>French</option><option>German</option>
                    </select>
                  </div>
                  <div class="knob-item"><label>Citation format</label>
                    <select class="knob-select" onchange="updateKnob('citation',this.value)">
                      <option>Numbered</option><option>APA</option><option>MLA</option><option>Chicago</option><option>Harvard</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="ct-right">
                <button class="attach-btn" onclick="openModal('upload')">
                  <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                </button>
                <button class="submit-btn" onclick="sendChat()">
                  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Below toolbar action chips -->
          <div style="display:flex; gap:6px; flex-wrap:wrap; padding-top:8px;">
            <button class="ct-btn" onclick="setPrompt('Chat with my file about ')">
              <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
              Chat with file ▾
            </button>
            <button class="ct-btn" onclick="setPrompt('Using folder ')">
              <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
              Chat with folder ▾
            </button>
            <button class="ct-btn" onclick="setPrompt('Learn about Anara ')">✕ Learn Anara</button>
            <button class="ct-btn" onclick="setPrompt('Search academic papers on ')">
              <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Search for papers
            </button>
            <button class="ct-btn" onclick="setPrompt('Outline a literature review on ')">⟳ Outline literature review</button>
            <button class="ct-btn" onclick="setPrompt('Search my workspace for ')">🗂 Search workspace</button>
            <button class="ct-btn" onclick="setPrompt('Create a citation for ')">📖 Create citation</button>
            <button class="ct-btn" onclick="toggleDropdown('more-actions-dd')" style="position:relative">
              More ▾
              <div class="fl-dropdown" id="more-actions-dd" style="bottom:100%; top:auto; margin-bottom:4px">
                <div class="fl-item" onclick="setPrompt('Search YouTube for ')">▶️ Search YouTube</div>
                <div class="fl-item" onclick="setPrompt('Create an image of ')">🎨 Create image</div>
                <div class="fl-item" onclick="setPrompt('Search Zotero for ')">📚 Search Zotero</div>
              </div>
            </button>
          </div>
        </div>
      </div>

    </div><!-- /center-body -->
  </div><!-- /center-panel -->

  <!-- ───────── RIGHT PANEL ───────── -->
  <div id="right-panel">
    <div class="right-header">
      <span class="right-title" id="right-title">Context</span>
      <button class="hdr-btn" onclick="toggleRight()" style="padding:4px 6px; border:none; background:none; color:var(--content-muted)">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="right-body" id="right-body">
      <div class="right-empty" id="right-empty">
        <svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.4" viewBox="0 0 24 24" style="opacity:0.3"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        <span>Citation context and sources will appear here when you interact with the agent.</span>
      </div>
    </div>
  </div>

</div><!-- /app -->

<!-- ───────── MODALS ───────── -->

<!-- Upload modal -->
<div class="modal-overlay" id="modal-upload">
  <div class="modal">
    <h3>Upload a file</h3>
    <p>Choose a destination folder, then select your file.</p>
    <select style="margin-bottom:12px">
      <option>Library (root)</option>
      <option>Transcendental Numbers</option>
      <option>Another Folder</option>
    </select>
    <input type="file" multiple style="margin-top:8px; border:none; padding:0; background:none; font-size:13px" />
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('upload')">Cancel</button>
      <button class="btn-primary" onclick="closeModal('upload')">Upload</button>
    </div>
  </div>
</div>

<!-- Create modal -->
<div class="modal-overlay" id="modal-create">
  <div class="modal">
    <h3>Create new</h3>
    <p>What would you like to create?</p>
    <div class="file-option" onclick="selectFileOpt(this)">
      <div class="file-option-check"><svg width="10" height="10" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
      <div><div style="font-weight:500; font-size:13px">Note / Document</div><div style="font-size:12px; color:var(--content-muted)">Create a rich text note with AI assistance</div></div>
    </div>
    <div class="file-option" onclick="selectFileOpt(this)">
      <div class="file-option-check"><svg width="10" height="10" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
      <div><div style="font-weight:500; font-size:13px">Folder</div><div style="font-size:12px; color:var(--content-muted)">Organize multiple files together</div></div>
    </div>
    <div class="file-option" onclick="selectFileOpt(this)">
      <div class="file-option-check"><svg width="10" height="10" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
      <div><div style="font-weight:500; font-size:13px">Chat</div><div style="font-size:12px; color:var(--content-muted)">Start a new agent chat session</div></div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('create')">Cancel</button>
      <button class="btn-primary" onclick="closeModal('create')">Create</button>
    </div>
  </div>
</div>

<!-- Chat with file modal -->
<div class="modal-overlay" id="modal-chat-file">
  <div class="modal">
    <h3>Chat with file(s)</h3>
    <p>Select one or more files to use as context for your chat.</p>
    <div class="file-option" onclick="selectFileOpt(this)">
      <div class="file-option-check"><svg width="10" height="10" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
      <div>
        <div style="font-weight:500; font-size:13px">Transcendental Numbers.pdf</div>
        <div style="font-size:12px; color:var(--content-muted)">Murty, et al. · Added today</div>
      </div>
    </div>
    <input type="file" multiple style="margin-top:8px; border:none; padding:0; background:none; font-size:12px; color:var(--content-muted)" />
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('chat-file')">Cancel</button>
      <button class="btn-primary" onclick="startFileChat()">Open chat →</button>
    </div>
  </div>
</div>

<!-- Chat with folder modal -->
<div class="modal-overlay" id="modal-chat-folder">
  <div class="modal">
    <h3>Chat with folder</h3>
    <p>Select a folder — all files inside will be used as RAG context.</p>
    <div class="file-option" onclick="selectFileOpt(this)">
      <div class="file-option-check"></div>
      <div><div style="font-weight:500; font-size:13px">Transcendental Numbers</div><div style="font-size:12px; color:var(--content-muted)">1 file</div></div>
    </div>
    <div class="file-option" onclick="selectFileOpt(this)">
      <div class="file-option-check"></div>
      <div><div style="font-weight:500; font-size:13px">Another Folder</div><div style="font-size:12px; color:var(--content-muted)">0 files</div></div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('chat-folder')">Cancel</button>
      <button class="btn-primary" onclick="startFolderChat()">Open chat →</button>
    </div>
  </div>
</div>

<!-- New workspace modal -->
<div class="modal-overlay" id="modal-new-workspace">
  <div class="modal">
    <h3>New workspace</h3>
    <p>Give your new research workspace a name.</p>
    <input type="text" id="new-ws-input-modal" placeholder="e.g. PhD Research, Book Club…" />
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('new-workspace')">Cancel</button>
      <button class="btn-primary" onclick="createNewWorkspace()">Create workspace</button>
    </div>
  </div>
</div>

<!-- Settings modal -->
<div class="modal-overlay" id="modal-settings">
  <div class="modal" style="min-width:440px">
    <h3>Settings</h3>
    <p>Workspace and account preferences.</p>
    <div style="display:flex; flex-direction:column; gap:10px">
      <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--content-border)">
        <div><div style="font-weight:500; font-size:13px">Workspace name</div><div style="font-size:12px; color:var(--content-muted)">Main Research</div></div>
        <button class="btn-secondary" style="font-size:12px; padding:5px 10px">Rename</button>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--content-border)">
        <div><div style="font-weight:500; font-size:13px">Default language</div></div>
        <select class="knob-select" style="border:1px solid var(--content-border)"><option>English</option><option>Hindi</option><option>Spanish</option></select>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0">
        <div><div style="font-weight:500; font-size:13px">Default citation style</div></div>
        <select class="knob-select" style="border:1px solid var(--content-border)"><option>Numbered</option><option>APA</option><option>MLA</option><option>Chicago</option></select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('settings')">Close</button>
      <button class="btn-primary" onclick="closeModal('settings')">Save</button>
    </div>
  </div>
</div>

<!-- New subfolder modal -->
<div class="modal-overlay" id="modal-new-subfolder">
  <div class="modal">
    <h3>New subfolder</h3>
    <p>Name your subfolder.</p>
    <input type="text" placeholder="e.g. Chapter 1, Notes…" />
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('new-subfolder')">Cancel</button>
      <button class="btn-primary" onclick="closeModal('new-subfolder')">Create</button>
    </div>
  </div>
</div>

<!-- Upgrade modal -->
<div class="modal-overlay" id="modal-upgrade">
  <div class="modal" style="min-width:400px; text-align:center">
    <div style="font-size:28px; margin-bottom:10px">✨</div>
    <h3 style="margin-bottom:6px">Upgrade to Pro</h3>
    <p>Unlock unlimited AI words, imports, and premium features.</p>
    <div style="display:flex; flex-direction:column; gap:8px; text-align:left; margin-bottom:16px">
      <div style="display:flex; align-items:center; gap:8px; font-size:13px"><span style="color:var(--accent)">✓</span> Unlimited AI words per day</div>
      <div style="display:flex; align-items:center; gap:8px; font-size:13px"><span style="color:var(--accent)">✓</span> Unlimited imports</div>
      <div style="display:flex; align-items:center; gap:8px; font-size:13px"><span style="color:var(--accent)">✓</span> Premium models (GPT-4o, Claude 3.5 Sonnet)</div>
      <div style="display:flex; align-items:center; gap:8px; font-size:13px"><span style="color:var(--accent)">✓</span> Priority support</div>
    </div>
    <div class="modal-actions" style="justify-content:center">
      <button class="btn-secondary" onclick="closeModal('upgrade')">Maybe later</button>
      <button class="btn-primary" style="background:var(--accent)" onclick="closeModal('upgrade')">Upgrade now</button>
    </div>
  </div>
</div>

<!-- Connect modal -->
<div class="modal-overlay" id="modal-connect">
  <div class="modal">
    <h3>Connect reference manager</h3>
    <p>Sync your Zotero or Mendeley library.</p>
    <div class="file-option" onclick="selectFileOpt(this)" style="margin-bottom:8px">
      <div class="file-option-check"></div>
      <div><div style="font-weight:500; font-size:13px">Zotero</div></div>
    </div>
    <div class="file-option" onclick="selectFileOpt(this)">
      <div class="file-option-check"></div>
      <div><div style="font-weight:500; font-size:13px">Mendeley</div></div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('connect')">Cancel</button>
      <button class="btn-primary" onclick="closeModal('connect')">Connect</button>
    </div>
  </div>
</div>

<script>
// ─── State ─────────────────────────────────────────────
let currentTab = 'home';
let rightVisible = true;
let leftVisible = true;
let libView = 'table';
let openTabs = [];
let currentDocTab = null;
let chatMessages = [];
let selectedMentions = [];
let settings = { scope: 'Workspace', lang: 'English', citation: 'Numbered', model: 'GPT OSS', words: '250 words' };
let workspaces = ['Main Research', 'Personal Projects', 'Collaboration'];
let activeWorkspace = 'Main Research';
let wsCloseTimer = null;

// ─── Tab switching ──────────────────────────────────────
function switchTab(tab) {
  currentTab = tab;
  ['home','library','agent'].forEach(t => {
    document.getElementById('view-' + t).style.display = t === tab ? (t === 'library' || t === 'agent' ? 'flex' : 'block') : 'none';
    document.getElementById('nav-' + t).classList.toggle('active', t === tab);
  });
  const icons = { home: 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z', library: 'M4 19.5A2.5 2.5 0 0 1 6.5 17H20M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z', agent: 'M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z' };
  const titles = { home: 'Home', library: 'Library', agent: 'Agent' };
  document.getElementById('center-title').innerHTML = `<svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="${icons[tab]}"/></svg>${titles[tab]}`;
  closeDropdowns();
}

// ─── Panel toggles ──────────────────────────────────────
function toggleLeft() {
  leftVisible = !leftVisible;
  document.getElementById('left-panel').classList.toggle('collapsed', !leftVisible);
  document.getElementById('left-open-btn').style.display = leftVisible ? 'none' : 'flex';
  document.getElementById('left-toggle').style.display = leftVisible ? 'flex' : 'none';
}
function toggleRight() {
  rightVisible = !rightVisible;
  document.getElementById('right-panel').classList.toggle('collapsed', !rightVisible);
}

// ─── User dropdown ──────────────────────────────────────
function toggleUserDropdown(e) {
  e.stopPropagation();
  const dd = document.getElementById('user-dropdown');
  const arrow = document.getElementById('user-arrow');
  const isOpen = dd.classList.contains('open');
  closeDropdowns();
  if (!isOpen) { dd.classList.add('open'); arrow.classList.add('open'); }
}
function closeDropdowns() {
  document.querySelectorAll('.user-dropdown, .fl-dropdown, .workspace-submenu, .mention-popup, .knob-popup').forEach(el => {
    el.classList.remove('open');
  });
  document.getElementById('user-arrow').classList.remove('open');
}
document.addEventListener('click', e => {
  if (!e.target.closest('.user-row') && !e.target.closest('.user-dropdown')) {
    document.getElementById('user-dropdown').classList.remove('open');
    document.getElementById('user-arrow').classList.remove('open');
  }
  if (!e.target.closest('.fl-dropdown') && !e.target.closest('.toolbar-btn') &&
      !e.target.closest('.ct-btn') && !e.target.closest('.chat-toolbar')) {
    document.querySelectorAll('.fl-dropdown').forEach(d => d.classList.remove('open'));
  }
  if (!e.target.closest('.chat-box')) {
    document.getElementById('mention-popup').classList.remove('open');
    document.getElementById('knob-dd').classList.remove('open');
  }
});

// ─── Workspace submenu ─────────────────────────────────
function openWsSubmenu() {
  cancelCloseWs();
  document.getElementById('ws-submenu').classList.add('open');
}
function scheduleCloseWs() {
  wsCloseTimer = setTimeout(() => {
    document.getElementById('ws-submenu').classList.remove('open');
    document.getElementById('ws-new-form').classList.remove('open');
  }, 300);
}
function cancelCloseWs() { clearTimeout(wsCloseTimer); }

function switchWorkspace(name) {
  activeWorkspace = name;
  document.querySelectorAll('.ws-item').forEach(el => {
    el.classList.toggle('active', el.textContent.trim() === name);
  });
  showToast(`Switched to "${name}"`);
  closeDropdowns();
}

function showNewWsForm() {
  const form = document.getElementById('ws-new-form');
  form.classList.add('open');
  document.getElementById('ws-new-input').focus();
}
function handleNewWs(e) {
  if (e.key === 'Enter') {
    const val = e.target.value.trim();
    if (!val) return;
    workspaces.push(val);
    // add to submenu
    const item = document.createElement('div');
    item.className = 'ws-item';
    item.textContent = val;
    item.onclick = () => switchWorkspace(val);
    const form = document.getElementById('ws-new-form');
    form.parentNode.insertBefore(item, form);
    e.target.value = '';
    form.classList.remove('open');
    switchWorkspace(val);
  }
}

// ─── Folder toggles ─────────────────────────────────────
function toggleFolder(id, el) {
  const list = document.getElementById(id);
  if (!list) return;
  list.classList.toggle('open');
  const toggle = el.querySelector('.folder-toggle');
  if (toggle) toggle.classList.toggle('open');
}

// ─── Plan details toggle ────────────────────────────────
function togglePlanDetails() {
  document.getElementById('plan-details').style.display =
    document.getElementById('plan-details').style.display === 'none' ? 'block' : 'none';
}

// ─── Modals ─────────────────────────────────────────────
function openModal(name) {
  closeDropdowns();
  document.getElementById('modal-' + name).classList.add('open');
}
function closeModal(name) {
  document.getElementById('modal-' + name).classList.remove('open');
}
// close on overlay click
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
});

function selectFileOpt(el) {
  el.closest('.modal').querySelectorAll('.file-option').forEach(f => f.classList.remove('selected'));
  el.classList.add('selected');
}

function startFileChat() {
  closeModal('chat-file');
  switchTab('agent');
  setTimeout(() => {
    document.getElementById('right-title').textContent = 'Context';
    setPrompt('Regarding Transcendental Numbers.pdf: ');
  }, 100);
}
function startFolderChat() {
  closeModal('chat-folder');
  switchTab('agent');
  setTimeout(() => setPrompt('Using files in folder: '), 100);
}

function createNewWorkspace() {
  const input = document.getElementById('new-ws-input-modal');
  const val = input.value.trim();
  if (val) {
    workspaces.push(val);
    input.value = '';
    closeModal('new-workspace');
    showToast(`Workspace "${val}" created!`);
  }
}

// ─── Library ─────────────────────────────────────────────
function setLibView(type, el) {
  libView = type;
  const tableView = document.getElementById('lib-table-view');
  const tabView = document.getElementById('lib-tab-view');
  if (type === 'table') {
    tableView.classList.remove('hidden');
    tabView.classList.remove('active');
  } else {
    tableView.classList.add('hidden');
    tabView.classList.add('active');
  }
  closeDropdowns();
}

function toggleCol(el, colClass) {
  el.classList.toggle('checked');
  const hasCheck = el.classList.contains('checked');
  const svg = el.querySelector('svg');
  if (svg) svg.style.visibility = hasCheck ? 'visible' : 'hidden';
  document.querySelectorAll('.' + colClass).forEach(col => {
    col.style.display = hasCheck ? '' : 'none';
  });
}

function toggleDropdown(id) {
  const el = document.getElementById(id);
  const wasOpen = el.classList.contains('open');
  document.querySelectorAll('.fl-dropdown, .knob-popup').forEach(d => d.classList.remove('open'));
  if (!wasOpen) el.classList.add('open');
}

function sortLib(col) {
  showToast(`Sorted by ${col}`);
  closeDropdowns();
}
function filterLib(col) {
  showToast(`Filter by ${col}`);
  closeDropdowns();
}

// doc tabs
function openDocTab(title, author) {
  setLibView('tab', null);
  document.getElementById('display-btn').textContent = 'Display ▾';
  if (!openTabs.find(t => t.title === title)) {
    openTabs.push({ title, author });
  }
  renderDocTabs(title);
}

function renderDocTabs(activeTitle) {
  currentDocTab = activeTitle || (openTabs[0] && openTabs[0].title);
  const bar = document.getElementById('doc-tabs-bar');
  bar.innerHTML = openTabs.map(t => `
    <div class="doc-tab ${t.title === currentDocTab ? 'active' : ''}" onclick="renderDocTabs('${t.title}')">
      <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
      ${t.title}
      <span class="close-tab" onclick="closeTab(event, '${t.title}')">✕</span>
    </div>
  `).join('');

  const area = document.getElementById('doc-content-area');
  const doc = openTabs.find(t => t.title === currentDocTab);
  if (doc) {
    area.innerHTML = `
      <h1>${doc.title}</h1>
      <div class="meta">${doc.author} &nbsp;·&nbsp; Added today &nbsp;·&nbsp; Document</div>
      <h2>Abstract</h2>
      <p>This monograph provides a comprehensive introduction to the theory of transcendental numbers, drawing on classical results by Hermite, Lindemann, Weierstrass, and Gelfond–Schneider. The authors present a self-contained treatment of the major transcendence methods including Baker's theory of linear forms in logarithms <a class="citation-link" onclick="showCitation(1)" title="Click to view source context">[1]</a>.</p>
      <h2>1. Introduction</h2>
      <p>A complex number is called <em>algebraic</em> if it is a root of a nonzero polynomial with rational coefficients. Numbers that are not algebraic are called <em>transcendental</em>. The existence of transcendental numbers was first proved by Liouville in 1844 <a class="citation-link" onclick="showCitation(2)" title="Click to view source context">[2]</a>, who constructed explicit examples. Later, Cantor gave an elegant proof using cardinality arguments.</p>
      <p>The most celebrated examples of transcendental numbers are <em>e</em> (Hermite, 1873) and <em>π</em> (Lindemann, 1882) <a class="citation-link" onclick="showCitation(3)" title="Click to view source context">[3]</a>. The proof that π is transcendental settled the ancient problem of squaring the circle negatively.</p>
      <h2>2. Liouville's Theorem</h2>
      <p>Liouville's theorem states that if α is an algebraic number of degree d ≥ 2, then there exists a constant c(α) > 0 such that for all rational numbers p/q, |α − p/q| > c(α)/q^d <a class="citation-link" onclick="showCitation(1)" title="Click to view source context">[1]</a>. This provides a quantitative measure of how well algebraic numbers can be approximated by rationals.</p>
    `;
  }
}

function closeTab(e, title) {
  e.stopPropagation();
  openTabs = openTabs.filter(t => t.title !== title);
  if (openTabs.length === 0) {
    setLibView('table', null);
    document.getElementById('doc-content-area').innerHTML = '<div style="padding:40px; color:var(--content-muted); font-size:13px">Open a file from the library to read it here.</div>';
  } else {
    renderDocTabs(openTabs[0].title);
  }
}

function showCitation(num) {
  const citations = {
    1: { text: 'Baker, A. (1975). Transcendental Number Theory. Cambridge University Press. Chapter 2: Linear forms in logarithms.', source: 'Transcendental Numbers.pdf · p. 14' },
    2: { text: 'Liouville, J. (1844). Sur des classes très étendues de quantités dont la valeur n\'est ni algébrique. Journal de Mathématiques, 16.', source: 'Transcendental Numbers.pdf · p. 3' },
    3: { text: 'Lindemann, F. (1882). Über die Zahl π. Mathematische Annalen, 20, 213–225. Proof that π satisfies no algebraic equation over the rationals.', source: 'Transcendental Numbers.pdf · p. 8' },
  };
  const c = citations[num];
  if (!c) return;
  const body = document.getElementById('right-body');
  document.getElementById('right-empty').style.display = 'none';
  body.innerHTML = `
    <div class="ctx-section">
      <div class="ctx-label">Citation [${num}] – Source context</div>
      <div class="ctx-item">
        <div class="ctx-num">[${num}]</div>
        <div>
          <div class="ctx-text">${c.text}</div>
          <div class="ctx-source">📄 ${c.source}</div>
        </div>
      </div>
    </div>
    <div class="ctx-section">
      <div class="ctx-label">All citations in this document</div>
      ${[1,2,3].map(n => `<div class="ctx-item" onclick="showCitation(${n})"><div class="ctx-num">[${n}]</div><div><div class="ctx-text" style="font-size:12px">${citations[n].text.substring(0,80)}…</div></div></div>`).join('')}
    </div>
  `;
  if (!rightVisible) toggleRight();
}

// ─── Agent / Chat ─────────────────────────────────────
function handleChatKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendChat();
  }
}

function handleChatInput(e) {
  const ta = e.target;
  ta.style.height = 'auto';
  ta.style.height = Math.min(ta.scrollHeight, 160) + 'px';
  const val = ta.value;
  const lastChar = val[val.length - 1];
  const popup = document.getElementById('mention-popup');
  if (lastChar === '@') popup.classList.add('open');
  else if (!val.includes('@')) popup.classList.remove('open');
}

function toggleMention() {
  const popup = document.getElementById('mention-popup');
  popup.classList.toggle('open');
}

function selectMention(name, type) {
  const ta = document.getElementById('chat-input');
  ta.value = ta.value.replace(/@$/, '') + `@${name} `;
  document.getElementById('mention-popup').classList.remove('open');
  ta.focus();
  selectedMentions.push({ name, type });
  showToast(`Added @${name}`);
}

function selectModel(m) {
  settings.model = m;
  document.getElementById('model-label').textContent = m;
  document.getElementById('model-btn').classList.add('selected');
  closeDropdowns();
}
function selectWords(w) {
  settings.words = w;
  document.getElementById('words-label').textContent = w;
  closeDropdowns();
}
function updateKnob(key, val) { settings[key] = val; }

function setPrompt(text) {
  switchTab('agent');
  setTimeout(() => {
    const ta = document.getElementById('chat-input');
    ta.value = text;
    ta.focus();
  }, 50);
}

const agentResponses = [
  `Based on your query and the context from <strong>Transcendental Numbers.pdf</strong>, here is a summary:<br><br>
  Transcendental number theory studies numbers that lie beyond algebraic reach. The field was pioneered by Liouville <a class="citation-link" onclick="showCitationAgent(1)">[1]</a> and later developed by Hermite and Lindemann, who proved the transcendence of <em>e</em> and <em>π</em> respectively <a class="citation-link" onclick="showCitationAgent(2)">[2]</a>.<br><br>
  Baker's theory of linear forms in logarithms <a class="citation-link" onclick="showCitationAgent(3)">[3]</a> represents the modern pinnacle of this field, with deep connections to Diophantine equations and elliptic curves.`,

  `I found several relevant papers on this topic. Here are the most cited ones from recent literature:<br><br>
  1. <strong>Waldschmidt (2000)</strong> – <em>Diophantine Approximation on Linear Algebraic Groups</em> — a comprehensive treatment of Baker's method <a class="citation-link" onclick="showCitationAgent(1)">[1]</a>.<br><br>
  2. <strong>Nesterenko (1996)</strong> — proved the algebraic independence of π and e^π <a class="citation-link" onclick="showCitationAgent(2)">[2]</a>, a landmark result.<br><br>
  3. <strong>Murty & Rath (2014)</strong> — the uploaded document provides an excellent pedagogical entry point <a class="citation-link" onclick="showCitationAgent(3)">[3]</a>.`,
];
let responseIdx = 0;

function sendChat() {
  const ta = document.getElementById('chat-input');
  const text = ta.value.trim();
  if (!text) return;

  const messagesEl = document.getElementById('agent-messages');
  document.getElementById('agent-empty').style.display = 'none';

  // user bubble
  chatMessages.push({ role: 'user', text });
  messagesEl.insertAdjacentHTML('beforeend', `
    <div class="msg user">
      <div class="msg-bubble">${escapeHtml(text)}</div>
    </div>
  `);

  ta.value = '';
  ta.style.height = 'auto';

  // typing indicator
  const typingId = 'typing-' + Date.now();
  messagesEl.insertAdjacentHTML('beforeend', `
    <div class="msg assistant" id="${typingId}">
      <div class="msg-avatar">A</div>
      <div class="msg-bubble">
        <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
      </div>
    </div>
  `);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  // simulate response
  setTimeout(() => {
    const el = document.getElementById(typingId);
    if (el) {
      const response = agentResponses[responseIdx % agentResponses.length];
      responseIdx++;
      el.querySelector('.msg-bubble').innerHTML = response;
      messagesEl.scrollTop = messagesEl.scrollHeight;
      showCitationAgent(1);
    }
  }, 1400);
}

function showCitationAgent(num) {
  const citations = {
    1: { text: 'Liouville, J. (1844). Sur des classes très étendues... Proof of existence of transcendental numbers.', source: 'Transcendental Numbers.pdf · p. 3' },
    2: { text: 'Hermite, C. (1873). Sur la fonction exponentielle. Académie des sciences. Proof of transcendence of e.', source: 'Transcendental Numbers.pdf · p. 7' },
    3: { text: 'Baker, A. (1975). Transcendental Number Theory. Cambridge. Baker\'s linear forms in logarithms.', source: 'Transcendental Numbers.pdf · p. 14' },
  };
  const c = citations[num];
  if (!c) return;
  const body = document.getElementById('right-body');
  document.getElementById('right-empty') && (document.getElementById('right-empty').style.display = 'none');
  body.innerHTML = `
    <div class="ctx-section">
      <div class="ctx-label">Source context for [${num}]</div>
      <div class="ctx-item">
        <div class="ctx-num">[${num}]</div>
        <div>
          <div class="ctx-text">${c.text}</div>
          <div class="ctx-source">📄 ${c.source}</div>
        </div>
      </div>
    </div>
    <div class="ctx-section">
      <div class="ctx-label">All citations in response</div>
      ${[1,2,3].map(n => `<div class="ctx-item" onclick="showCitationAgent(${n})"><div class="ctx-num">[${n}]</div><div><div class="ctx-text" style="font-size:12px">${citations[n].text.substring(0,70)}…</div></div></div>`).join('')}
    </div>
    <div class="ctx-section">
      <div class="ctx-label">Settings used</div>
      <div style="font-size:12px; color:var(--content-muted); line-height:1.8; padding:6px 0">
        Model: ${settings.model}<br>
        Length: ${settings.words}<br>
        Citation: ${settings.citation}<br>
        Language: ${settings.lang || 'English'}<br>
        Scope: ${settings.scope || 'Workspace'}
      </div>
    </div>
  `;
  if (!rightVisible) toggleRight();
}

function escapeHtml(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ─── Toast ───────────────────────────────────────────────
function showToast(msg) {
  let t = document.getElementById('toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'toast';
    t.style.cssText = `position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
      background:#111; color:#fff; padding:9px 18px; border-radius:20px;
      font-size:13px; z-index:9999; box-shadow:0 4px 20px rgba(0,0,0,0.2);
      opacity:0; transition:opacity 0.2s; pointer-events:none; font-family:'DM Sans',sans-serif;`;
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.opacity = '1';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.style.opacity = '0', 2500);
}

// ─── Init ────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  // Show left toggle
  document.getElementById('left-toggle').style.display = 'flex';
  // Keep plan details visible
  document.getElementById('plan-details').style.display = 'block';
});
</script>
</body>
</html>
